<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Task Details</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6366f1", // Indigo-500
                        "primary-glow": "#818cf8",
                        "accent": "#10b981", // Emerald-500
                        "danger": "#f43f5e", // Rose-500
                        "dark-bg": "#0B0C15", // Deep Space Black
                        "glass-surface": "rgba(255, 255, 255, 0.03)",
                        "glass-border": "rgba(255, 255, 255, 0.08)",
                        "glass-highlight": "rgba(255, 255, 255, 0.1)",
                    },
                    fontFamily: {
                        "display": ["Outfit", "sans-serif"]
                    },
                    boxShadow: {
                        "neon": "0 0 20px rgba(99, 102, 241, 0.4)",
                        "glass": "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.1)",
                        "glass-hover": "0 10px 15px -3px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)"
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'mesh': "radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%)",
                    }
                },
            },
        }
    </script>
    <style>
        body {
            background-color: #0B0C15;
            color: #E2E8F0;
        }

        .glass-card {
            background: rgba(20, 21, 31, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:disabled {
            background: transparent;
            border-color: transparent;
            color: #94a3b8;
            cursor: default;
        }

        .glass-input:not(:disabled):focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            background: rgba(0, 0, 0, 0.4);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Edit Mode Transitions */
        .edit-controls {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .view-mode .edit-controls {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="app.js"></script>
</head>

<body class="bg-dark-bg font-display min-h-screen selection:bg-primary/30 selection:text-white view-mode" id="body-el">
    <!-- Ambient Background Mesh -->
    <div class="fixed inset-0 z-0 opacity-40 bg-mesh pointer-events-none"></div>

    <div
        class="relative z-10 flex h-full min-h-screen w-full flex-col overflow-x-hidden max-w-md mx-auto border-x border-glass-border bg-dark-bg/50 backdrop-blur-sm">

        <!-- Header -->
        <div
            class="flex items-center justify-between p-6 pb-4 sticky top-0 z-20 bg-dark-bg/80 backdrop-blur-xl border-b border-glass-border">
            <a id="back-btn" href="index.html"
                class="flex items-center justify-center size-10 rounded-full hover:bg-white/10 transition-colors text-white">
                <span class="material-symbols-rounded">arrow_back</span>
            </a>
            <h1 class="text-lg font-bold tracking-wide text-white">Mission Details</h1>
            <button id="edit-toggle-btn"
                class="flex items-center gap-2 px-4 py-2 rounded-full glass-card hover:bg-white/10 transition-all text-xs font-bold uppercase tracking-widest text-primary hover:text-white border-primary/30 shadow-neon">
                <span class="material-symbols-rounded text-sm" id="edit-icon">edit</span>
                <span id="edit-text">Edit</span>
            </button>
        </div>

        <div class="flex-1 flex flex-col p-6 gap-6">

            <!-- Title Section -->
            <div class="space-y-2">
                <label class="sr-only">Title</label>
                <textarea id="task-title-input" rows="2"
                    class="w-full bg-transparent border-0 p-0 text-3xl font-bold text-white placeholder:text-gray-600 focus:ring-0 resize-none leading-tight"
                    placeholder="Mission Objective..." disabled></textarea>
            </div>

            <!-- Meta Grid -->
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-3 rounded-xl space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold block">Priority</label>
                    <select id="task-priority"
                        class="w-full bg-transparent border-0 p-0 text-sm font-bold text-white focus:ring-0 cursor-pointer disabled:cursor-default"
                        disabled>
                        <option value="High">High Priority</option>
                        <option value="Medium">Medium Priority</option>
                        <option value="Low">Low Priority</option>
                    </select>
                </div>
                <div class="glass-card p-3 rounded-xl space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold block">Sector</label>
                    <select id="task-category"
                        class="w-full bg-transparent border-0 p-0 text-sm font-bold text-white focus:ring-0 cursor-pointer disabled:cursor-default"
                        disabled>
                        <option value="Work">Work</option>
                        <option value="Personal">Personal</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
            </div>

            <!-- Status Card -->
            <div class="glass-card p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="status-indicator"
                        class="size-3 rounded-full bg-gray-500 shadow-[0_0_10px_rgba(107,114,128,0.5)]"></div>
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Current Status</p>
                        <select id="task-status"
                            class="bg-transparent border-0 p-0 text-sm font-bold text-white focus:ring-0 cursor-pointer disabled:cursor-default"
                            disabled>
                            <option value="Todo">Todo</option>
                            <option value="In Progress">In Progress</option>
                            <option value="In Review">In Review</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="space-y-2">
                <div class="flex items-center gap-2 text-primary">
                    <span class="material-symbols-rounded text-lg">description</span>
                    <h3 class="text-sm font-bold uppercase tracking-widest">Briefing</h3>
                </div>
                <div class="glass-card p-4 rounded-2xl min-h-[100px]">
                    <textarea id="task-description"
                        class="w-full bg-transparent border-0 p-0 text-sm text-gray-300 focus:ring-0 resize-none leading-relaxed min-h-[80px]"
                        placeholder="No additional briefing provided." disabled></textarea>
                </div>
            </div>

            <!-- Subtasks -->
            <div class="space-y-3">
                <div class="flex items-center justify-between text-primary">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-rounded text-lg">checklist</span>
                        <h3 class="text-sm font-bold uppercase tracking-widest">Objectives</h3>
                    </div>
                    <span id="subtask-count"
                        class="text-xs bg-white/10 px-2 py-0.5 rounded text-white font-mono">0/0</span>
                </div>

                <div id="subtasks-container" class="space-y-2">
                    <!-- Dynamic Subtasks -->
                </div>

                <div class="edit-controls">
                    <button id="add-subtask-btn"
                        class="w-full py-3 rounded-xl border border-dashed border-glass-border text-gray-500 hover:text-white hover:border-white/30 hover:bg-white/5 transition-all text-sm font-medium flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">add</span>
                        Add Objective
                    </button>
                </div>
            </div>

            <!-- Tags -->
            <div class="space-y-3">
                <div class="flex items-center gap-2 text-primary">
                    <span class="material-symbols-rounded text-lg">label</span>
                    <h3 class="text-sm font-bold uppercase tracking-widest">Tags</h3>
                </div>
                <div id="tags-container" class="flex flex-wrap gap-2">
                    <!-- Tags -->
                </div>
                <div class="edit-controls mt-2">
                    <div class="flex gap-2">
                        <input id="new-tag-input" type="text" placeholder="Add tag..."
                            class="glass-input flex-1 rounded-lg px-3 py-2 text-xs">
                        <button id="add-tag-btn"
                            class="px-3 rounded-lg bg-primary/20 text-primary hover:bg-primary hover:text-white transition-colors">
                            <span class="material-symbols-rounded text-sm">add</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Messages Section -->
            <div class="space-y-3">
                <div class="flex items-center gap-2 text-primary">
                    <span class="material-symbols-rounded text-lg">chat</span>
                    <h3 class="text-sm font-bold uppercase tracking-widest">Comms</h3>
                </div>
                <div id="messages-container" class="flex flex-col gap-3 max-h-60 overflow-y-auto pr-2">
                    <!-- Messages -->
                </div>
                <div class="flex gap-2 mt-2">
                    <input id="new-message-input" type="text" placeholder="Transmit message..."
                        class="glass-input flex-1 rounded-xl px-4 py-3 text-sm">
                    <button id="send-message-btn"
                        class="size-11 flex items-center justify-center rounded-xl bg-primary text-white shadow-neon hover:scale-105 active:scale-95 transition-all">
                        <span class="material-symbols-rounded">send</span>
                    </button>
                </div>
            </div>

            <!-- Attachments -->
            <div class="space-y-3 pb-20">
                <div class="flex items-center gap-2 text-primary">
                    <span class="material-symbols-rounded text-lg">attach_file</span>
                    <h3 class="text-sm font-bold uppercase tracking-widest">Data</h3>
                </div>
                <div id="attachments-list" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                    <!-- Attachments -->
                    <div id="add-attachment-btn"
                        class="flex flex-col gap-2 shrink-0 w-24 cursor-pointer group opacity-60 hover:opacity-100 transition-opacity">
                        <div
                            class="flex items-center justify-center rounded-xl aspect-square w-full border border-dashed border-gray-600 bg-white/5 group-hover:border-primary/50 group-hover:bg-primary/10 transition-colors">
                            <span class="material-symbols-rounded text-gray-400 group-hover:text-primary">add</span>
                        </div>
                        <p class="text-[10px] text-center text-gray-500 font-medium truncate">Upload</p>
                    </div>
                </div>
                <input type="file" id="attachment-input" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx,.xlsx">
            </div>

        </div>

        <!-- Footer Actions -->
        <div class="sticky bottom-0 z-20 w-full p-4 bg-dark-bg/90 backdrop-blur-xl border-t border-glass-border">
            <div class="flex gap-4">
                <button id="delete-task-btn"
                    class="size-12 rounded-xl flex items-center justify-center text-danger hover:bg-danger/10 transition-colors">
                    <span class="material-symbols-rounded">delete</span>
                </button>
                <button id="mark-complete-btn"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-primary-glow text-white font-bold shadow-neon hover:opacity-90 active:scale-98 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                    <span class="material-symbols-rounded">check_circle</span>
                    <span>Complete Mission</span>
                </button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bodyEl = document.getElementById('body-el');
            const params = new URLSearchParams(window.location.search);
            const taskId = params.get('id');
            const isNew = params.get('new') === 'true';
            const isBoard = params.get('isboard') === 'true';

            // Navigation
            if (isBoard) document.getElementById('back-btn').href = 'board.html';

            let currentTask;

            // Initialize Data
            if (isNew) {
                currentTask = {
                    id: crypto.randomUUID(),
                    title: 'New Mission',
                    priority: 'Medium',
                    status: 'Todo',
                    category: 'Work',
                    dueDate: new Date().toISOString(),
                    description: '',
                    subtasks: [],
                    tags: [],
                    messages: [],
                    attachments: []
                };
                // If new, start in edit mode immediately
                bodyEl.classList.remove('view-mode');
                toggleEditMode(true);
            } else {
                currentTask = TaskManager.getById(taskId);
                if (!currentTask) {
                    alert('Mission not found.');
                    window.location.href = 'index.html';
                    return;
                }
            }

            // Elements
            const inputs = {
                title: document.getElementById('task-title-input'),
                description: document.getElementById('task-description'),
                priority: document.getElementById('task-priority'),
                status: document.getElementById('task-status'),
                category: document.getElementById('task-category')
            };
            const editBtn = document.getElementById('edit-toggle-btn');
            const editText = document.getElementById('edit-text');
            const editIcon = document.getElementById('edit-icon');

            // Populate Fields
            function populateUI() {
                inputs.title.value = currentTask.title;
                inputs.description.value = currentTask.description;
                inputs.priority.value = currentTask.priority;
                inputs.status.value = currentTask.status;
                inputs.category.value = currentTask.category;

                updateStatusVisuals(currentTask.status);
                renderSubtasks();
                renderTags();
                renderMessages();
                renderAttachments();

                // Resize textarea
                inputs.description.style.height = 'auto';
                inputs.description.style.height = inputs.description.scrollHeight + 'px';
            }

            function updateStatusVisuals(status) {
                const ind = document.getElementById('status-indicator');
                let color = '#9ca3af'; // gray
                if (status === 'In Progress') color = '#6366f1';
                if (status === 'In Review') color = '#c084fc';
                if (status === 'Accepted') color = '#10b981';
                if (status === 'Rejected') color = '#f43f5e';

                ind.style.backgroundColor = color;
                ind.style.boxShadow = `0 0 10px ${color}`;
            }

            // --- Edit Mode Logic ---
            let isEditing = isNew; // Start editing if new

            function toggleEditMode(forceState) {
                if (typeof forceState !== 'undefined') isEditing = forceState;
                else isEditing = !isEditing;

                if (isEditing) {
                    bodyEl.classList.remove('view-mode');
                    editText.textContent = 'Save';
                    editIcon.textContent = 'save';
                    editBtn.classList.replace('text-primary', 'text-white');
                    editBtn.classList.replace('bg-transparent', 'bg-primary');
                    editBtn.classList.add('bg-primary', 'text-white');

                    // Enable inputs
                    Object.values(inputs).forEach(input => input.disabled = false);

                } else {
                    saveTaskData();
                    bodyEl.classList.add('view-mode');
                    editText.textContent = 'Edit';
                    editIcon.textContent = 'edit';
                    editBtn.classList.remove('bg-primary', 'text-white');
                    // Disable inputs
                    Object.values(inputs).forEach(input => input.disabled = true);
                }
            }

            function saveTaskData() {
                currentTask.title = inputs.title.value;
                currentTask.description = inputs.description.value;
                currentTask.priority = inputs.priority.value;
                currentTask.status = inputs.status.value;
                currentTask.category = inputs.category.value;

                TaskManager.save(currentTask);
                console.log('Saved:', currentTask);
                updateStatusVisuals(currentTask.status);

                if (isNew) {
                    // Remove new param from url to prevent re-init
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.delete('new');
                    newUrl.searchParams.set('id', currentTask.id);
                    window.history.replaceState({}, '', newUrl);
                    isNew = false;
                }
            }

            editBtn.addEventListener('click', () => toggleEditMode());

            // --- Subtasks ---
            // --- Subtasks ---
            function renderSubtasks() {
                const container = document.getElementById('subtasks-container');
                container.innerHTML = '';

                const countEl = document.getElementById('subtask-count');
                const total = currentTask.subtasks.length;
                const done = currentTask.subtasks.filter(s => s.completed).length;
                countEl.textContent = `${done}/${total}`;

                currentTask.subtasks.forEach((sub, idx) => {
                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-3 rounded-xl glass-card ${sub.completed ? 'opacity-50' : ''}`;

                    // Determine if we should be disabled (based on current mode)
                    const disabled = !isEditing;

                    div.innerHTML = `
                    <button class="subtask-check size-5 rounded-full border-2 flex items-center justify-center transition-colors ${sub.completed ? 'bg-primary border-primary' : 'border-gray-500 hover:border-primary'}">
                        ${sub.completed ? '<span class="material-symbols-rounded text-xs text-white">check</span>' : ''}
                    </button>
                    <input type="text" class="subtask-input flex-1 bg-transparent border-none p-0 text-sm ${sub.completed ? 'line-through text-gray-500' : 'text-white'} focus:ring-0" value="${sub.title}" ${disabled ? 'disabled' : ''}>
                    <button class="delete-sub-btn text-danger opacity-0 group-hover:opacity-100 transition-opacity p-1 edit-controls">
                        <span class="material-symbols-rounded text-sm">close</span>
                    </button>
                `;

                    // Checkbox
                    div.querySelector('.subtask-check').onclick = () => {
                        sub.completed = !sub.completed;
                        TaskManager.save(currentTask);
                        renderSubtasks();
                    };

                    // Input Edit
                    const input = div.querySelector('.subtask-input');
                    input.addEventListener('change', () => {
                        sub.title = input.value;
                    });

                    // Delete
                    div.querySelector('.delete-sub-btn').onclick = () => {
                        currentTask.subtasks.splice(idx, 1);
                        renderSubtasks(); // Main save handler will catch if "Save" is clicked, or auto-save if in view mode?
                        // If we are default-edit, we wait for Save button.
                    };

                    container.appendChild(div);
                });
            }

            document.getElementById('add-subtask-btn').onclick = () => {
                const title = prompt("New Objective:");
                if (title) {
                    currentTask.subtasks.push({ title, completed: false });
                    renderSubtasks(); // Don't save yet, wait for main Save
                }
            };

            // --- Tags ---
            function renderTags() {
                const container = document.getElementById('tags-container');
                container.innerHTML = '';
                currentTask.tags.forEach((tag, idx) => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-1 rounded bg-white/10 text-[10px] font-bold uppercase tracking-wider text-gray-300 flex items-center gap-1";
                    span.innerHTML = `${tag} <button class="hover:text-white edit-controls"><span class="material-symbols-rounded text-xs">close</span></button>`;
                    span.querySelector('button').onclick = () => {
                        currentTask.tags.splice(idx, 1);
                        renderTags();
                    };
                    container.appendChild(span);
                });
            }

            document.getElementById('add-tag-btn').onclick = () => {
                const input = document.getElementById('new-tag-input');
                if (input.value.trim()) {
                    currentTask.tags.push(input.value.trim());
                    input.value = '';
                    renderTags();
                }
            }

            // --- Messages (Always Active) ---
            function renderMessages() {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                currentTask.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = "bg-white/5 p-3 rounded-tr-xl rounded-br-xl rounded-bl-xl text-sm text-gray-300 border border-white/5";
                    div.innerHTML = `${msg.text} <div class="text-[10px] text-gray-600 mt-1 text-right">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            }

            document.getElementById('send-message-btn').onclick = () => {
                const input = document.getElementById('new-message-input');
                if (input.value.trim()) {
                    currentTask.messages.push({
                        text: input.value.trim(),
                        timestamp: Date.now(),
                        sender: 'user'
                    });
                    TaskManager.save(currentTask); // Messages save immediately
                    renderMessages();
                    input.value = '';
                }
            };

            // --- Attachments (Always Active for Upload) ---
            function renderAttachments() {
                // Logic similar to prev version but styled
                const list = document.getElementById('attachments-list');
                // Remove all except add btn
                Array.from(list.children).forEach(c => {
                    if (c.id !== 'add-attachment-btn') list.removeChild(c);
                });

                currentTask.attachments.forEach(att => {
                    const div = document.createElement('div');
                    div.className = "shrink-0 w-24 flex flex-col gap-2 group relative";

                    let preview = `<div class="aspect-square rounded-xl bg-white/5 border border-white/10 flex items-center justify-center"><span class="material-symbols-rounded text-gray-500">description</span></div>`;
                    if (att.type.startsWith('image/')) preview = `<div class="aspect-square rounded-xl bg-cover bg-center border border-white/10" style="background-image: url('${att.data}')"></div>`;

                    div.innerHTML = `${preview}<p class="text-[10px] truncate text-gray-500 group-hover:text-gray-300 transition-colors">${att.name}</p>`;
                    list.insertBefore(div, document.getElementById('add-attachment-btn'));
                });
            }

            const attachInput = document.getElementById('attachment-input');
            document.getElementById('add-attachment-btn').onclick = () => attachInput.click();
            attachInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    TaskManager.addAttachment(currentTask.id, {
                        name: file.name,
                        type: file.type,
                        data: ev.target.result
                    });
                    currentTask = TaskManager.getById(currentTask.id); // Reload
                    renderAttachments();
                };
                reader.readAsDataURL(file);
            };

            // --- Footer Actions ---
            document.getElementById('mark-complete-btn').onclick = () => {
                currentTask.status = currentTask.status === 'Completed' ? 'Todo' : 'Completed';
                TaskManager.save(currentTask);
                populateUI();
            };

            document.getElementById('delete-task-btn').onclick = () => {
                if (confirm('Abort Mission? This cannot be undone.')) {
                    TaskManager.delete(currentTask.id);
                    window.location.href = 'index.html';
                }
            };

            // Init
            populateUI();
            // Set initial disable state
            // User requested active edit mode by default
            toggleEditMode(true);
        });
    </script>
</body>

</html>